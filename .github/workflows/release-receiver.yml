name: Release manuscripts-receiver

# Trigger by pushing a tag like: git tag receiver-v1.2 && git push origin receiver-v1.2
on:
  push:
    tags:
      - 'receiver-v*'

jobs:
  build-mac:
    name: Build (macOS)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Build app
        run: |
          cd manuscripts-receiver
          pip install --quiet pyinstaller aiohttp zeroconf pystray Pillow pyobjc
          python make_icons.py
          pyinstaller --onedir --windowed \
            --name "manuscripts receiver" \
            --icon icon.icns \
            --collect-all zeroconf \
            --collect-all aiohttp \
            --collect-all pystray \
            --hidden-import pystray._darwin \
            --hidden-import tkinter \
            --add-data "JetBrainsMono-Regular.ttf:." \
            --add-data "JetBrainsMono-Light.ttf:." \
            receiver.py
      - name: Package DMG
        run: |
          TAG="${GITHUB_REF_NAME}"
          VERSION="${TAG#receiver-v}"
          DMG="manuscripts-receiver-mac-v${VERSION}.dmg"
          mkdir manuscripts-receiver/dist/dmg-staging
          cp -r "manuscripts-receiver/dist/manuscripts receiver.app" "manuscripts-receiver/dist/dmg-staging/"
          ln -s /Applications "manuscripts-receiver/dist/dmg-staging/Applications"
          hdiutil create \
            -volname "manuscripts receiver" \
            -srcfolder "manuscripts-receiver/dist/dmg-staging" \
            -ov \
            -format UDZO \
            "manuscripts-receiver/dist/${DMG}"
          echo "ASSET=manuscripts-receiver/dist/${DMG}" >> "$GITHUB_ENV"
      - uses: actions/upload-artifact@v4
        with:
          name: mac-build
          path: ${{ env.ASSET }}

  build-windows:
    name: Build (Windows)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Build binary
        run: |
          cd manuscripts-receiver
          pip install --quiet pyinstaller aiohttp zeroconf pystray Pillow pywin32
          python make_icons.py
          pyinstaller --onefile --noconsole `
            "--name" "manuscripts-receiver" `
            --icon icon.ico `
            --collect-all zeroconf `
            --collect-all aiohttp `
            --collect-all pystray `
            --hidden-import pystray._win32 `
            --hidden-import tkinter `
            "--add-data" "JetBrainsMono-Regular.ttf;." `
            "--add-data" "JetBrainsMono-Light.ttf;." `
            receiver.py
      - name: Rename exe
        shell: bash
        run: |
          TAG="${GITHUB_REF_NAME}"
          VERSION="${TAG#receiver-v}"
          mv "manuscripts-receiver/dist/manuscripts-receiver.exe" \
             "manuscripts-receiver/dist/manuscripts-receiver-win-v${VERSION}.exe"
          echo "ASSET=manuscripts-receiver/dist/manuscripts-receiver-win-v${VERSION}.exe" >> "$GITHUB_ENV"
      - uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: ${{ env.ASSET }}

  release:
    name: Create GitHub Release
    needs: [build-mac, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
      - name: Publish release
        uses: softprops/action-gh-release@v2
        with:
          name: manuscripts receiver ${{ github.ref_name }}
          body: |
            ## manuscripts receiver ${{ github.ref_name }}

            **macOS**: open the DMG, drag `manuscripts receiver` to Applications
            *(first run: right-click → Open to bypass Gatekeeper)*

            **Windows**: double-click `manuscripts-receiver-win-v*.exe`
            *(first run: click "More info" → "Run anyway" to bypass SmartScreen)*

            A setup dialog will appear on first launch to set your name and password.
            The app then runs in the system tray — look for the gold icon.
          files: |
            artifacts/mac-build/*.dmg
            artifacts/windows-build/*.exe
